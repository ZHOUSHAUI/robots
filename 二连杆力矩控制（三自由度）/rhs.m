function zdot=rhs(t,z0,flag) 
global ulink I1 I2 
global G 
g=G; 
 m1=ulink.m1;m2=ulink.m2; 
l1=ulink.l1;l2=ulink.l2; 
q1=z0(1);q2=z0(3);q3=z0(5); 
w1=z0(2);w2=z0(4);w3=z0(6); 
w1_z=w1;w2_x=w2; w3_x=w3;
I1_11=I1(1,1);I1_12=I1(1,2);I1_13=I1(1,3);
I1_21=I1(2,1);I1_22=I1(2,2);I1_23=I1(2,3);
I1_31=I1(3,1);I1_32=I1(3,2);I1_33=I1(3,3);
I2_11=I2(1,1);I2_12=I2(1,2);I2_13=I2(1,3);
I2_21=I2(2,1);I2_22=I2(2,2);I2_23=I2(2,3);
I2_31=I2(3,1);I2_32=I2(3,2);I2_33=I2(3,3);

s_v=[q1,w1,q2,w2,q3,w3];
[T1,T2,T3]=control_strategy(t,s_v);

m11=I1_22/2 + I1_33/2 + I2_22/2 + I2_33/2 - (I2_22*cos(2*q2 + 2*q3))/2 + (I2_33*cos(2*q2 + 2*q3))/2 - (I2_23*sin(2*q2 + 2*q3))/2 - (I2_32*sin(2*q2 + 2*q3))/2 + (l1^2*m1)/8 + (l1^2*m2)/2 + (l2^2*m2)/8 - (I1_22*cos(2*q2))/2 + (I1_33*cos(2*q2))/2 - (I1_23*sin(2*q2))/2 - (I1_32*sin(2*q2))/2 - (l1^2*m1*cos(2*q2))/8 - (l1^2*m2*cos(2*q2))/2 - (l2^2*m2*cos(2*q2 + 2*q3))/8 + (l1*l2*m2*cos(q3))/2 - (l1*l2*m2*cos(2*q2 + q3))/2; 
m12=(I2_13*cos(q2 + q3))/2 + (I2_31*cos(q2 + q3))/2 - (I2_12*sin(q2 + q3))/2 - (I2_21*sin(q2 + q3))/2 + (I1_13*cos(q2))/2 + (I1_31*cos(q2))/2 - (I1_12*sin(q2))/2 - (I1_21*sin(q2))/2; 
m13=(I2_13*cos(q2 + q3))/2 + (I2_31*cos(q2 + q3))/2 - (I2_12*sin(q2 + q3))/2 - (I2_21*sin(q2 + q3))/2; 
m21=(I2_13*cos(q2 + q3))/2 + (I2_31*cos(q2 + q3))/2 - (I2_12*sin(q2 + q3))/2 - (I2_21*sin(q2 + q3))/2 + (I1_13*cos(q2))/2 + (I1_31*cos(q2))/2 - (I1_12*sin(q2))/2 - (I1_21*sin(q2))/2; 
m22=I1_11 + I2_11 + (l1^2*m1)/4 + l1^2*m2 + (l2^2*m2)/4 + l1*l2*m2*cos(q3); 
m23=I2_11 + (l2^2*m2)/4 + (l1*l2*m2*cos(q3))/2; 
m31=(I2_13*cos(q2 + q3))/2 + (I2_31*cos(q2 + q3))/2 - (I2_12*sin(q2 + q3))/2 - (I2_21*sin(q2 + q3))/2; 
m32=I2_11 + (l2^2*m2)/4 + (l1*l2*m2*cos(q3))/2; 
m33=I2_11 + (l2^2*m2)/4; 
rhs1=I2_22*w2_x*w1_z*sin(2*q2 + 2*q3) - (I2_12*w2_x^2*cos(q2 + q3))/2 - (I2_12*w3_x^2*cos(q2 + q3))/2 - (I2_21*w2_x^2*cos(q2 + q3))/2 - (I2_21*w3_x^2*cos(q2 + q3))/2 - (I2_13*w2_x^2*sin(q2 + q3))/2 - (I2_13*w3_x^2*sin(q2 + q3))/2 - (I2_31*w2_x^2*sin(q2 + q3))/2 - (I2_31*w3_x^2*sin(q2 + q3))/2 - (I1_12*w2_x^2*cos(q2))/2 - (I1_21*w2_x^2*cos(q2))/2 - (I1_13*w2_x^2*sin(q2))/2 - (I1_31*w2_x^2*sin(q2))/2 - T1 + I2_22*w1_z*w3_x*sin(2*q2 + 2*q3) - I2_33*w2_x*w1_z*sin(2*q2 + 2*q3) - I2_33*w1_z*w3_x*sin(2*q2 + 2*q3) - I2_12*w2_x*w3_x*cos(q2 + q3) - I2_21*w2_x*w3_x*cos(q2 + q3) - I2_13*w2_x*w3_x*sin(q2 + q3) - I2_31*w2_x*w3_x*sin(q2 + q3) - I1_23*w2_x*w1_z*cos(2*q2) - I1_32*w2_x*w1_z*cos(2*q2) + I1_22*w2_x*w1_z*sin(2*q2) - I1_33*w2_x*w1_z*sin(2*q2) - I2_23*w2_x*w1_z*cos(2*q2 + 2*q3) - I2_23*w1_z*w3_x*cos(2*q2 + 2*q3) - I2_32*w2_x*w1_z*cos(2*q2 + 2*q3) - I2_32*w1_z*w3_x*cos(2*q2 + 2*q3) + (l1^2*m1*w2_x*w1_z*sin(2*q2))/4 + l1^2*m2*w2_x*w1_z*sin(2*q2) + (l2^2*m2*w2_x*w1_z*sin(2*q2 + 2*q3))/4 + (l2^2*m2*w1_z*w3_x*sin(2*q2 + 2*q3))/4 - (l1*l2*m2*w1_z*w3_x*sin(q3))/2 + l1*l2*m2*w2_x*w1_z*sin(2*q2 + q3) + (l1*l2*m2*w1_z*w3_x*sin(2*q2 + q3))/2; 
rhs2=(I1_23*w1_z^2*cos(2*q2))/2 - T2 + (I1_32*w1_z^2*cos(2*q2))/2 - (I1_22*w1_z^2*sin(2*q2))/2 + (I1_33*w1_z^2*sin(2*q2))/2 - g*m2*((l2*sin(q2 + q3))/2 + l1*sin(q2)) + (I2_23*w1_z^2*cos(2*q2 + 2*q3))/2 + (I2_32*w1_z^2*cos(2*q2 + 2*q3))/2 - (I2_22*w1_z^2*sin(2*q2 + 2*q3))/2 + (I2_33*w1_z^2*sin(2*q2 + 2*q3))/2 - (g*l1*m1*sin(q2))/2 - (l1^2*m1*w1_z^2*sin(2*q2))/8 - (l1^2*m2*w1_z^2*sin(2*q2))/2 - (l2^2*m2*w1_z^2*sin(2*q2 + 2*q3))/8 - (l1*l2*m2*w3_x^2*sin(q3))/2 - (l1*l2*m2*w1_z^2*sin(2*q2 + q3))/2 - l1*l2*m2*w2_x*w3_x*sin(q3); 
rhs3=(I2_23*w1_z^2*cos(2*q2 + 2*q3))/2 - T3 + (I2_32*w1_z^2*cos(2*q2 + 2*q3))/2 - (I2_22*w1_z^2*sin(2*q2 + 2*q3))/2 + (I2_33*w1_z^2*sin(2*q2 + 2*q3))/2 - (g*l2*m2*sin(q2 + q3))/2 - (l2^2*m2*w1_z^2*sin(2*q2 + 2*q3))/8 + (l1*l2*m2*w2_x^2*sin(q3))/2 + (l1*l2*m2*w1_z^2*sin(q3))/4 - (l1*l2*m2*w1_z^2*sin(2*q2 + q3))/4; 
M=[m11,m12,m13;m21,m22,m23;m31,m32,m33];
RHS=[rhs1;rhs2;rhs3]; 

X=-M\RHS ;
dw1=X(1);dw2=X(2);dw3=X(3); 
zdot=[w1_z dw1 w2_x dw2 w3_x dw3]';
end
